<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<html>
<head>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" type="text/css" rel="stylesheet"/>
<link href="main.css" type="text/css" rel="stylesheet"/>
<script>
    $(document).ready(function () {
	/*setInterval(function() {
     $.get("https://c8d4f510a703.ngrok.io",
                function (result, status, xhr) {
				console.log(JSON.parse(result));
                    $("#returnedData").html(result);
                }
                ).fail(function (xhr, status, error) {
                    $("#returnedData").html("Result: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
            });
	}, 10000);*/
	var chat_result =  (localStorage.getItem("chat_result")) ? JSON.parse(localStorage.getItem("chat_result")) : {};
	var chat_room = (localStorage.getItem("chat_room")) ? JSON.parse(localStorage.getItem("chat_room")) : {};
	console.log(chat_result);
	console.log(chat_room);
	//var chat_result = {};
	var chat_id = (localStorage.getItem("chat_id")) ? localStorage.getItem("chat_id") : 0;
	var token = "1800161917:AAEXlYjI3UVkV0rvzKxH6A3dbjPKIjqz8zs";
	var url = "https://api.telegram.org/bot"+token+"/";
	//var server = "https://c8d4f510a703.ngrok.io";
	var msg_id = 0;
	//$("#chat_id").trigger( "change" );
	if(!jQuery.isEmptyObject(chat_result)){
		appendMsg();
		appendChatroom()
	}else{
		getMsg();
	}
	setInterval(function() {
		getMsg();
	}, 10000);
	
	

	function getMsg(){
		$.get( url+"getupdates")
		.done(function( data ) {
			if(data.ok){
				jQuery.each( data.result, function( index, val ) {
					var message = val.message;
					var first_name = (message.from.first_name) ? message.from.first_name : "";
					var last_name = (message.from.last_name) ? message.from.last_name : "";
					var title = (message.chat.title) ? message.chat.title : first_name + " "+ last_name;
					//console.log(message);
					if(!chat_result[message.chat.id]){
						$("#chat_id").append('<option value="'+message.chat.id+'">'+title+'</option>');
						chat_result[message.chat.id] = {};
						chat_room[message.chat.id] = title;
						localStorage.setItem("chat_room", JSON.stringify(chat_room));
					}
					
					if(!chat_result[message.chat.id][message.message_id]){
						var msg = "";
						var file_id = '';
						if((message.text)){
							msg = message.text;
						}else if(message.sticker){
							if(!message.sticker.is_animated){
								file_id = message.sticker.file_id;
							}
							msg = message.sticker.set_name+":"+message.sticker.emoji;
						}else if(message.animation){
							file_id = message.animation.file_id;
							msg = (message.caption) ? message.caption  + ":"+ message.animation.mime_type : message.animation.mime_type;
						}else if(message.photo){
							file_id = message.photo[message.photo.length - 1].file_id;
							msg = (message.caption) ? message.caption  + ":Photo" : message.photo[message.photo.length - 1].file_unique_id+ ":Photo";
						}
						var v = {
								first_name:first_name,
								last_name:last_name,
								message_id:message.message_id,
								msg : msg,
								file_id : file_id,
								date:message.date,
								};
						var result = JSON.parse(localStorage.getItem("chat_result"));
						let combine = {
							...result,
							...chat_result
						};
						chat_result[message.chat.id][message.message_id] = v;
						localStorage.setItem("chat_result", JSON.stringify(combine));
						if(chat_id == message.chat.id){
							var msg = '<div class="incoming_msg">';
							msg += '<div class="incoming_msg_img"> '+v.first_name + " " +v.last_name+' </div>';
							msg += '<div class="received_msg"><div class="received_withd_msg">';
							msg += '<p class="msg_box" data-msg_id="'+v.message_id+'">'+v.msg+'</p>';
							if(v.file_id){
							msg += '<button data-file_id="'+v.file_id+'" class="btn open_media" type="submit"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></button>';
							}
							msg += '<span class="time_date">'+v.date+'</span> </div>';
							msg += '</div></div></div>';								
							$(".msg_history").append(msg);
						}
					}
				});
			}
		});
	}
	$("#msg").submit(function(event){
		event.preventDefault();
		var msg = { chat_id: chat_id, text: $(".write_msg").val()};
		if(msg_id){
			msg.reply_to_message_id = msg_id;
		}
		
		$.get( url+"sendMessage", msg)
		.done(function( data ) {
			if(data.ok){
				var msg = '<div class="outgoing_msg"><div class="sent_msg">';
                msg += '<p>'+$(".write_msg").val()+'</p>'
				$(".msg_history").append(msg);
				$(".write_msg").val("");
				msg_id = 0;
			}
		});
	});
	$( ".msg_history" ).on( "click", '.msg_box', function() {
		msg_id = $( this ).data("msg_id");
		text = $(this).text();
		$('#reply_msg').text(text);
	});

	$( ".msg_history" ).on( "click", '.open_media', function() {
	    var msg_button = $(this);
		$.get( url+"getFile", {file_id:msg_button.data("file_id")})
		.done(function( data ) {
			if(data.ok){
				var file_path = "https://api.telegram.org/file/bot"+token+"/"+data.result.file_path;
				if(file_path.endsWith("MP4")){
					var msg = '<video width="450" height="360" autoplay controls  loop>';
					msg += '<source src="'+file_path+'" type="video/mp4">';
					msg += '</video>';
				}else if(file_path.endsWith("jpg") || file_path.endsWith("webp")){
					var msg = '<img src="'+file_path+'"/>';
				}else{
					var msg = file_path;
				}
				msg_button.closest(".received_withd_msg").find(".msg_box").html(msg);
				msg_button.remove();
			}
		});
	
	});
	$("#chat_id").change(function(){
		chat_id = ($(this).val()) ? $(this).val() : chat_id;
		console.log(chat_id);
		localStorage.setItem("chat_id", chat_id);
		$(".msg_history").empty();
		appendMsg();
	});
	
	function appendChatroom(){
		jQuery.each( chat_room, function( index, v ) {
			$("#chat_id").append('<option value="'+index+'">'+v+'</option>');
		});
	}
	
	function appendMsg(){
		jQuery.each( chat_result[chat_id], function( index, v ) {
			var msg = '<div class="incoming_msg">';
			msg += '<div class="incoming_msg_img"> '+v.first_name + " " +v.last_name+' </div>';
			msg += '<div class="received_msg"><div class="received_withd_msg">';
			msg += '<p class="msg_box" data-msg_id="'+v.message_id+'">'+v.msg+'</p>';
			if(v.file_id){
				msg += '<button data-file_id="'+v.file_id+'" class="btn open_media" type="submit"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></button>';
				}
				msg += '<span class="time_date">'+v.date+'</span> </div>';
				msg += '</div></div></div>';								
				$(".msg_history").append(msg);
		});
	}
	
    }); 
</script>

</head>
<body>
<div class="container">
<h3 class=" text-center">Messaging <div style='float: right;' id="chat"><select id="chat_id" name="chat_id"><option value="0">Chat List</option></select></div></h3>
<div class="messaging">
      <div class="inbox_msg">
        <div class="mesgs">
          <div class="msg_history">            
          </div>
          <div class="type_msg">
            <div class="input_msg_write">
			<div id='reply_msg'></div>
			<form id="msg">
              <input type="text" class="write_msg" placeholder="Type a message" />
              <button class="msg_send_btn" type="submit"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></button>
            </form>
			</div>
          </div>
        </div>
      </div>
    </div></div>
    </body>
    </html>